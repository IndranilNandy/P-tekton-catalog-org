apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: catalog-build-pipeline-r-
spec:

  taskRunTemplate:
    serviceAccountName: test-service-account
    podTemplate:
      securityContext:
        fsGroup: 65532

  params:
    # For git-clone task
    - name: git-clone
      value:
        url: "git@github.com:IndranilNandy/demo-app-to-test-pipeline"
        revision: "master"

    # For gradle task
    - name: gradle
      value:
        gradle-image: "gradle:8.7.0-jdk17"
        project-dir: "."
    - name: gradle-params-tasks
      value:
        - build
        - publish
        - -PbuildDir=$(params.common.build-artifacts-root)/$(params.common.project-build-dir-name)
        - --console=verbose
        # - --status
        # no improvement with --no-daemon; also gradle now doesn't suggest to disable daemong in CI
        # - --no-daemon

    # Pipeline commons
    - name: common
      value:
        build-artifacts-root: "/tmp/myproject/build-artifacts"
        project-build-dir-name: "build"

    # Debugging purpose
    - name: debug
      value:
        clone-source-repo-disabled: "false"
        build-test-publish-artifacts-disabled: "false"

  workspaces:
    - name: shared-workspace
      persistentVolumeClaim:
        claimName: test-catalog-pipeline-build-pipeline-pvc
      subPath: kaniko-pipeline/

    # - name: ssh-directory
    #   secret:
    #     secretName: git-creds-ssh-secret-3

    # - name: docker-credentials
    #   secret:
    #     secretName: test-docker-credentials

  pipelineRef:
    resolver: git
    params:
      - name: repo
        value: P-tekton-catalog-org
      - name: pathInRepo
        value: pipeline/build-code-and-image/build-pipeline.yaml