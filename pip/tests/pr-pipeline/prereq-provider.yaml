apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: catalog-pr-pipeline-prereq-provider
spec:
  params:

    # github-set-status commons
    - name: github-set-status
      type: object
      properties:
        github-host-url:
          type: string
        api-path-prefix:
          type: string
        repo-full-name:
          type: string
        github-token-secret-name:
          type: string
        github-token-secret-key:
          type: string
        sha:
          type: string
        target-url:
          type: string
        description:
          type: string
        context:
          type: string
        state:
          type: string
        auth-type:
          type: string
        image:
          type: string
        shebang:
          type: string
      default:
        github-host-url: "api.github.com"
        api-path-prefix: ""
        description: "PR pipeline: Tasks should set the description individually"
        context: "ci/pr"
        # Valid values for state: One of failure/pending/success
        state: "pending"
        auth-type: "Bearer"
        image: "python:3.10.1-alpine3.15"
        shebang: /usr/bin/env python
        target-url: "$(params.common.tekton-dashboard)/#/namespaces/$(context.pipelineRun.namespace)/pipelineruns/$(context.pipelineRun.name)"

    # Pipeline commons
    - name: common
      type: object
      properties:
        tekton-dashboard:
          type: string
        # create-pr:
        #   type: string
      default:
        tekton-dashboard: "http://localhost:8090"

    # Debugging purpose
    - name: debug
      type: object
      description: all debug switches and properties
      properties:
        set-github-status-pr-created-disabled:
          type: string
        # build-test-publish-artifacts-disabled:
        #   type: string
      default:
        set-github-status-pr-created-disabled: "false"
        # build-test-publish-artifacts-disabled: "false"

  tasks:
    - name: pr-pipeline
      params:
        # For github-set-status task
        - name: github-set-status
          value:
            github-host-url: "$(params.github-set-status.github-host-url)"
            repo-full-name: "$(params.github-set-status.repo-full-name)"
            github-token-secret-name: "$(params.github-set-status.github-token-secret-name)"
            github-token-secret-key: "$(params.github-set-status.github-token-secret-key)"
            # sha: dev
            sha: "$(params.github-set-status.sha)"
            description: "$(params.github-set-status.description)"
            context: "$(params.github-set-status.context)"

        # Pipeline commons
        - name: common
          value:
            tekton-dashboard: "$(params.common.tekton-dashboard)"
            # build-artifacts-root: "/tmp/myproject/build-artifacts"
            # project-build-dir-name: "build"
            # create-pr: "false"

        # Debugging purpose
        - name: debug
          value:
            set-github-status-pr-created-disabled: "$(params.debug.set-github-status-pr-created-disabled)"

      taskRef:
        apiVersion: tekton.dev/v1beta1
        kind: Pipeline
        name: pr-pipeline